---
  - hosts: all
    become: yes
    tasks:
    - name: Update package list
      apt: update_cache=yes
      become: true

    - name: Debug message after updating package list
      debug:
        msg: "Package list updated successfully on {{ inventory_hostname }}."

    - name: Install common packages
      apt:
        name: 
          - git
          - nfs-common
          - net-tools
          - htop
          - apt-transport-https
          - ca-certificates
          - software-properties-common
          - curl
          - grep
          - unzip
          - zip
          - nano
          - grep
          - tree
          - ntp
          - ntpstat
          - ntpdate
        update_cache: yes
        cache_valid_time: 86400
        state: latest
      become: true

    - name: Debug message after installing common packages
      debug:
        msg: >
          Common packages installed successfully on {{ inventory_hostname }}. 
          Packages installed: 
          {% for item in install_result.results %}
            {% if item.changed %}
              {{ item.item }}
            {% endif %}
          {% endfor %}

    - name: Copy telegraf.conf for RPis
      copy:
        src: config_files/telegraf/telegraf_pi.conf
        dest: /etc/telegraf/telegraf.conf
        owner: root
        group: root
        mode: 0644
      become: yes
      when: "'rpi' in group_names"

    - name: Add InfluxData GPG key
      shell: |
        curl --silent --location -O https://repos.influxdata.com/influxdata-archive.key
        echo "943666881a1b8d9b849b74caebf02d3465d6beb716510d86a39f6c8e8dac7515  influxdata-archive.key" | sha256sum -c -
        cat influxdata-archive.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/influxdata-archive.gpg > /dev/null
      become: yes

    - name: Add InfluxData repository
      shell: |
        echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive.gpg] https://repos.influxdata.com/debian stable main' | sudo tee /etc/apt/sources.list.d/influxdata.list
      become: yes

    - name: Update package list after adding InfluxData repository
      apt: update_cache=yes
      become: true

    - name: Install Telegraf
      apt:
        name: telegraf
        state: latest
      become: true

    - name: Debug message after installing Telegraf
      debug:
        msg: "Telegraf installed successfully on {{ inventory_hostname }}."

    - name: Restart Telegraf
      service:
        name: telegraf
        state: restarted
        enabled: yes
      become: yes

    - name: Wait for 20 seconds
      wait_for:
        timeout: 20

    - name: Get Telegraf status
      shell: systemctl status telegraf
      register: telegraf_status
      become: yes

    - name: Debug message after restarting Telegraf
      debug:
        msg: >
          Telegraf restarted successfully on {{ inventory_hostname }}.
          {% if 'active (running)' in telegraf_status.stdout %}
            Telegraf is running:
            {{ telegraf_status.stdout }}
          {% else %}
            Telegraf encountered an error:
            {{ telegraf_status.stderr }}
          {% endif %}